{% extends "base.html" %}

{% block title %}Admin Dashboard - Verwaltungsplattform{% endblock %}

{% block content %}
<h1>Hallo, {{ session['username'] }}!</h1>
<div class="user-info" style="margin-bottom: 20px;">Ihre Rolle: <strong>{{ session['role'] }}</strong></div>

<!-- Flash messages -->
{% with messages = get_flashed_messages(with_categories=true) %}
  {% if messages %}
    <div class="flashes" style="margin-bottom: 20px;">
      {% for category, message in messages %}
        <div
          role="alert"
          class="flash-message {{ category }}"
          style="
            padding: 12px 15px;
            border-radius: 5px;
            margin-bottom: 8px;
            color: {% if category == 'success' %}#155724{% elif category == 'error' %}#721c24{% else %}#0c5460{% endif %};
            background-color: {% if category == 'success' %}#d4edda{% elif category == 'error' %}#f8d7da{% else %}#d1ecf1{% endif %};
            border: 1px solid {% if category == 'success' %}#c3e6cb{% elif category == 'error' %}#f5c6cb{% else %}#bee5eb{% endif %};
          "
        >
          {{ message }}
        </div>
      {% endfor %}
    </div>
  {% endif %}
{% endwith %}

<div class="stats" style="display: flex; gap: 40px; margin-bottom: 25px;">
  <div class="stat-box" style="flex: 1; padding: 20px; border: 1px solid #ddd; border-radius: 10px; background: #f9f9f9; text-align: center;">
    <h2>Tägliche Einnahmen</h2>
    <p style="font-size: 2em; font-weight: bold; margin: 0;">€{{ "{:,.2f}".format(daily_profit|default(0)) }}</p>
  </div>

  <div class="stat-box" style="flex: 1; padding: 20px; border: 1px solid #ddd; border-radius: 10px; background: #f9f9f9; text-align: center;">
    <h2>Aktueller Kontostand (Wallet)</h2>
    <p style="font-size: 2em; font-weight: bold; margin: 0;">€{{ "{:,.2f}".format(wallet_balance|default(0)) }}</p>
  </div>

  <div class="stat-box" style="flex: 1; padding: 20px; border: 1px solid #ddd; border-radius: 10px; background: #f9f9f9; text-align: center;">
    <h2>Monatlicher Gesamtgewinn</h2>
    <p style="font-size: 2em; font-weight: bold; margin: 0;">€{{ "{:,.2f}".format(monthly_profit|default(0)) }}</p>
  </div>

  <div class="stat-box" style="flex: 1; padding: 20px; border: 1px solid #ddd; border-radius: 10px; background: #f9f9f9; text-align: center;">
    <h2>Wallet + Täglicher Gewinn</h2>
    <p style="font-size: 2em; font-weight: bold; margin: 0;">€{{ "{:,.2f}".format((wallet_balance|default(0)) + (daily_profit|default(0))) }}</p>
  </div>

  <div class="stat-box" style="flex: 1; padding: 20px; border: 1px solid #ddd; border-radius: 10px; background: #f9f9f9; text-align: center;">
    <h2>Gesamtgewinn (Allzeit)</h2>
    <p style="font-size: 2em; font-weight: bold; margin: 0;">€{{ "{:,.2f}".format(all_time_profit|default(0)) }}</p>
  </div>
</div>

<!-- Wallet balance input form -->
<!-- Existing wallet balance form -->
<form method="POST" action="{{ url_for('set_wallet_balance') }}" style="margin-bottom: 20px; max-width: 480px; display: flex; align-items: center; gap: 12px; flex-wrap: wrap;">
  <label for="wallet_balance" style="font-weight: 600; white-space: nowrap;">Wallet-Bestand vor Arbeitsbeginn setzen:</label>
  <input 
    type="number" step="0.01" min="0" 
    id="wallet_balance" name="wallet_balance" 
    value="{{ wallet_balance or 0 }}" 
    required
    aria-label="Wallet-Bestand vor Arbeitsbeginn"
    style="padding: 8px 12px; width: 130px; border-radius: 4px; border: 1px solid #ccc;"
  >
  <button type="submit" style="
    padding: 9px 18px;
    background-color: #4CAF50; 
    color: white; 
    border: none; 
    border-radius: 5px;
    cursor: pointer;
    font-weight: 600;
    transition: background-color 0.3s ease;
  " 
  onmouseover="this.style.backgroundColor='#45a049'" 
  onmouseout="this.style.backgroundColor='#4CAF50'">
    Speichern
  </button>

  <!-- Reset button inside same form -->
  <button type="submit" formaction="{{ url_for('reset_wallet_balance') }}" style="
    padding: 9px 18px;
    background-color: #f44336; 
    color: white; 
    border: none; 
    border-radius: 5px;
    cursor: pointer;
    font-weight: 600;
    transition: background-color 0.3s ease;
  " 
  onmouseover="this.style.backgroundColor='#d32f2f'" 
  onmouseout="this.style.backgroundColor='#f44336'">
    Reset Wallet auf 0
  </button>
</form>



<!-- CSV Download Buttons -->
<div style="margin-bottom: 40px;">
  <a href="{{ url_for('download_sales_csv') }}" style="margin-right: 15px; padding: 10px 20px; background-color: #3a7d44; color: white; text-decoration: none; border-radius: 5px; font-weight: 600;">Verkaufs-Historie CSV herunterladen</a>
  <a href="{{ url_for('download_purchases_csv') }}" style="padding: 10px 20px; background-color: #a83a3a; color: white; text-decoration: none; border-radius: 5px; font-weight: 600;">Einkaufs-Historie CSV herunterladen</a>
</div>

<!-- Sales and Purchases side by side -->
<div style="display: flex; gap: 30px; flex-wrap: wrap;">

  <!-- Sales section -->
  <section style="flex: 1; min-width: 320px; border: 2px solid #a8d5a2; padding: 18px; border-radius: 10px; background: #f0faf0;">
    <h2 style="color: #3a7d44; margin-bottom: 15px;">Verkäufe (Sales)</h2>
    <table style="width: 100%; border-collapse: collapse;">
      <thead style="background-color: #d9ead3;">
        <tr>
          <th style="padding: 10px; border-bottom: 2px solid #b4d2b4; text-align: left;">Datum</th>
          <th style="padding: 10px; border-bottom: 2px solid #b4d2b4; text-align: left;">Artikel</th>
          <th style="padding: 10px; border-bottom: 2px solid #b4d2b4; text-align: center;">Menge</th>
          <th style="padding: 10px; border-bottom: 2px solid #b4d2b4; text-align: right;">Preis pro Stück</th>
          <th style="padding: 10px; border-bottom: 2px solid #b4d2b4; text-align: right;">Gesamtpreis</th>
        </tr>
      </thead>
      <tbody>
        {% for sale in sales %}
        <tr style="border-bottom: 1px solid #c5e1a5;">
          <td style="padding: 8px;">{{ sale.date | datetimeformat }}</td>
          <td style="padding: 8px;">{{ sale.name if sale.name else 'Unbekannt' }}</td>
          <td style="padding: 8px; text-align: center;">{{ sale.quantity|default(0) }}</td>
          <td style="padding: 8px; text-align: right;">€{{ "{:,.2f}".format(sale.sale_price|default(0)) }}</td>
          <td style="padding: 8px; text-align: right;">€{{ "{:,.2f}".format(sale.total_price|default(0)) }}</td>
        </tr>
        {% else %}
        <tr><td colspan="5" style="text-align: center; padding: 15px;">Keine Verkaufsdaten vorhanden.</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </section>

  <!-- Purchases section -->
  <section style="flex: 1; min-width: 320px; border: 2px solid #e79a9a; padding: 18px; border-radius: 10px; background: #faf0f0;">
    <h2 style="color: #a83a3a; margin-bottom: 15px;">Einkäufe (Purchases)</h2>
    <table style="width: 100%; border-collapse: collapse; font-family: Arial, sans-serif;">
      <thead>
        <tr style="background-color: #f8d7da; color: #721c24;">
          <th style="padding: 10px; border-bottom: 2px solid #f5c6cb; text-align: left;">Datum</th>
          <th style="padding: 10px; border-bottom: 2px solid #f5c6cb; text-align: left;">Artikel</th>
          <th style="padding: 10px; border-bottom: 2px solid #f5c6cb; text-align: center;">Menge</th>
          <th style="padding: 10px; border-bottom: 2px solid #f5c6cb; text-align: right;">Preis pro Stück</th>
          <th style="padding: 10px; border-bottom: 2px solid #f5c6cb; text-align: right;">Gesamtpreis</th>
        </tr>
      </thead>
      <tbody>
        {% for purchase in purchases %}
        <tr style="border-bottom: 1px solid #f1b0b7;">
          <td style="padding: 8px;">{{ purchase.date | datetimeformat }}</td>
          <td style="padding: 8px;">{{ purchase.product_name if purchase.product_name else 'Unbekannt' }}</td>
          <td style="padding: 8px; text-align: center;">{{ purchase.quantity|default(0) }}</td>
          <td style="padding: 8px; text-align: right;">€{{ "{:,.2f}".format(purchase.purchase_price|default(0)) }}</td>
          <td style="padding: 8px; text-align: right;">€{{ "{:,.2f}".format(purchase.total_price|default(0)) }}</td>
        </tr>
        {% else %}
        <tr><td colspan="5" style="text-align: center; padding: 15px;">Keine Einkaufsdaten vorhanden.</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </section>
</div>
{% endblock %}
