{% extends "base.html" %}
{% block title %}Meine Verk√§ufe{% endblock %}

{% block content %}
<div class="table-responsive">
  <h2>Meine Verk√§ufe</h2>
  <input type="text" id="searchInput" class="form-control mb-3" placeholder="üîç Suche nach Produktname..." onkeyup="filterTable()">

  <table class="table table-striped">
    <thead>
      <tr>
        <th>#</th>
        <th>Produkt</th>
        <th>Menge</th>
        <th>Preis pro St√ºck (‚Ç¨)</th>
        <th>Gesamtpreis (‚Ç¨)</th>
        <th>Datum</th>
        <th>Aktionen</th>
      </tr>
    </thead>
    <tbody>
      {% set counter = 1 %}
      {% for order in sales %}
        {% for item in order["items"] %}
          <tr>
            <td>{{ counter }}</td>
            <td>{{ item.product_name | default('Unbekannt') }}</td>
            <td>{{ item.quantity | default(0) }}</td>
            <td>{{ "%.2f"|format(item.sale_price | float(0)) }}</td>
            <td>{{ "%.2f"|format(item.total_price | float(0)) }}</td>
            <td>{{ order.date[:10] | default('') }}</td>
            <td class="d-flex gap-1 flex-wrap">
              <!-- Quittung Button -->
              <button
                onclick='showReceiptInPopup({{
                  {
                    "date": order.date | default(''),
                    "item_name": item.product_name | default("Unbekannt"),
                    "barcode": item.barcode | default(""),
                    "quantity": item.quantity | default(0),
                    "sale_price": item.sale_price | default(0),
                    "total_price": item.total_price | default(0)
                  } | tojson | safe
                }})'
                class="btn btn-sm btn-info" title="Quittung anzeigen"
              >
                <i class="bi bi-receipt"></i>
              </button>

              <!-- Edit Button -->
              <a href="{{ url_for('edit_sale', order_id=order.order_id, barcode=item.barcode | default('')) }}"
                 class="btn btn-sm btn-warning" title="Bearbeiten">
                <i class="bi bi-pencil-square"></i>
              </a>

              <!-- Delete Button -->
              <form method="post" action="{{ url_for('delete_sale', order_id=order.order_id, barcode=item.barcode | default('')) }}" 
                    onsubmit="return confirm('Verkauf wirklich l√∂schen?')">
                <button type="submit" class="btn btn-sm btn-danger" title="L√∂schen">
                  <i class="bi bi-trash"></i>
                </button>
              </form>
            </td>
          </tr>
          {% set counter = counter + 1 %}
        {% endfor %}
      {% else %}
        <tr><td colspan="7" class="text-center">Keine Verk√§ufe gefunden.</td></tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<script>
function filterTable() {
  const input = document.getElementById("searchInput");
  const filter = input.value.toLowerCase();
  const rows = document.querySelectorAll("table tbody tr");

  rows.forEach(row => {
    const productName = row.cells[1].textContent.toLowerCase();
    row.style.display = productName.includes(filter) ? "" : "none";
  });
}

// Show receipt popup
function showReceiptInPopup(sale) {
  const username = "{{ session['username'] | e }}";
  const receiptHTML = `
    <!DOCTYPE html>
    <html>
    <head>
      <title>Verkaufsquittung</title>
      <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        h3, h4 { margin-top: 0; }
        table { width: 100%; font-size: 0.95em; border-collapse: collapse; }
        td { padding: 4px 8px; vertical-align: top; }
        hr { margin: 20px 0; }
        .header { display: flex; align-items: center; margin-bottom: 20px; }
        .header img { height: 60px; margin-right: 15px; }
        .footer { font-size: 0.8em; text-align: right; }
      </style>
    </head>
    <body onload="window.print()">
      <div class="header">
        <img src="${location.origin}/static/images/logo.png" alt="Logo">
        <div>
          <h3>Meine Firma</h3>
          <p>Musterstra√üe 1, 12345 Musterstadt</p>
          <p>Tel: 01234 567890 | info@meinefirma.de</p>
        </div>
      </div>

      <hr>

      <h4>Verkaufsquittung</h4>
      <table>
        <tr><td><strong>Datum:</strong></td><td>${sale.date.replace("T", " ").slice(0, 19)}</td></tr>
        <tr><td><strong>Artikel:</strong></td><td>${sale.item_name}</td></tr>
        <tr><td><strong>Barcode:</strong></td><td>${sale.barcode}</td></tr>
        <tr><td><strong>Menge:</strong></td><td>${sale.quantity}</td></tr>
        <tr><td><strong>Einzelpreis:</strong></td><td>${sale.sale_price.toFixed(2)} ‚Ç¨</td></tr>
        <tr><td><strong>Gesamtpreis:</strong></td><td>${sale.total_price.toFixed(2)} ‚Ç¨</td></tr>
        <tr><td><strong>Verk√§ufer:</strong></td><td>${username}</td></tr>
      </table>

      <hr>
      <p class="footer">Vielen Dank f√ºr Ihren Einkauf!</p>
    </body>
    </html>
  `;

  const receiptWindow = window.open('', '_blank', 'width=800,height=600');
  if (receiptWindow) {
    receiptWindow.document.open();
    receiptWindow.document.write(receiptHTML);
    receiptWindow.document.close();
  } else {
    alert("Pop-up Fenster blockiert. Bitte erlauben Sie Pop-ups f√ºr diese Seite.");
  }
}
</script>
{% endblock %}
