{% extends "base.html" %}
{% block title %}Meine Verk√§ufe{% endblock %}

{% block content %}
<div class="table-responsive">
  <h2>Meine Verk√§ufe</h2>
  <input type="text" id="searchInput" class="form-control mb-3" placeholder="üîç Suche nach Produktname..." onkeyup="filterTable()">

  <table class="table table-striped">
    <thead>
      <tr>
        <th>#</th>
        <th>Produkt</th>
        <th>Menge</th>
        <th>Preis pro St√ºck (‚Ç¨)</th>
        <th>Gesamtpreis (‚Ç¨)</th>
        <th>Datum</th>
        <th>Aktionen</th>
      </tr>
    </thead>
    {% set counter = 1 %}
{% for order in sales %}
  {% set receipt_button_shown = False %}
  {% for item in order["items"] %}
    <tr>
      <td>{{ counter }}</td>
      <td>{{ item.product_name | default('Unbekannt') }}</td>
      <td>{{ item.quantity | default(0) }}</td>
      <td>{{ "%.2f"|format(item.sale_price | float(0)) }}</td>
      <td>{{ "%.2f"|format(item.total_price | float(0)) }}</td>
      <td>{{ order.date[:10] | default('') }}</td>
      <td class="d-flex gap-1 flex-wrap">
        {# ‚úÖ Show receipt button only once per order #}
        {% if not receipt_button_shown %}
          <button
            onclick='showReceiptInPopup({{ order | tojson | safe }})'
            class="btn btn-sm btn-primary"
            title="Quittung f√ºr Bestellung"
          >
            <i class="bi bi-receipt"></i>
          </button>
          {% set receipt_button_shown = True %}
        {% endif %}

        <!-- Edit button (still per item) -->
        <a href="{{ url_for('edit_sale', order_id=order.order_id, barcode=item.barcode | default('')) }}"
           class="btn btn-sm btn-warning" title="Bearbeiten">
          <i class="bi bi-pencil-square"></i>
        </a>

        <!-- Delete button (still per item) -->
        <form method="post" action="{{ url_for('delete_sale', order_id=order.order_id, barcode=item.barcode | default('')) }}"
              onsubmit="return confirm('Verkauf wirklich l√∂schen?')">
          <button type="submit" class="btn btn-sm btn-danger" title="L√∂schen">
            <i class="bi bi-trash"></i>
          </button>
        </form>
      </td>
    </tr>
    {% set counter = counter + 1 %}
  {% endfor %}
{% else %}
  <tr><td colspan="7" class="text-center">Keine Verk√§ufe gefunden.</td></tr>
{% endfor %}

  </table>
</div>

<script>
function filterTable() {
  const input = document.getElementById("searchInput");
  const filter = input.value.toLowerCase();
  const rows = document.querySelectorAll("table tbody tr");

  rows.forEach(row => {
    const productName = row.cells[1].textContent.toLowerCase();
    row.style.display = productName.includes(filter) ? "" : "none";
  });
}


function showReceiptInPopup(order) {
  const username = "{{ session['username'] | e }}";

  let itemsHTML = "";
  order.items.forEach(item => {
    itemsHTML += `
      <tr>
        <td>${item.product_name}</td>
        <td>${item.barcode}</td>
        <td>${item.quantity}</td>
        <td>${item.sale_price.toFixed(2)} ‚Ç¨</td>
        <td>${item.total_price.toFixed(2)} ‚Ç¨</td>
      </tr>
    `;
  });

  const receiptHTML = `
    <!DOCTYPE html>
    <html>
    <head>
      <title>Verkaufsquittung</title>
      <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        h3, h4 { margin-top: 0; }
        table { width: 100%; font-size: 0.95em; border-collapse: collapse; }
        td, th { padding: 6px 10px; border: 1px solid #ccc; text-align: left; }
        hr { margin: 20px 0; }
        .header { display: flex; align-items: center; margin-bottom: 20px; }
        .header img { height: 60px; margin-right: 15px; }
        .footer { font-size: 0.8em; text-align: right; margin-top: 20px; }
      </style>
    </head>
    <body onload="window.print()">
      <div class="header">
        <img src="${location.origin}/static/images/logo.png" alt="Logo">
        <div>
          <h3>Meine Firma</h3>
          <p>Musterstra√üe 1, 12345 Musterstadt</p>
          <p>Tel: 01234 567890 | info@meinefirma.de</p>
        </div>
      </div>

      <hr>

      <h4>Verkaufsquittung</h4>
      <p><strong>Bestellnummer:</strong> ${order.order_id}</p>
      <p><strong>Datum:</strong> ${order.date.replace("T", " ").slice(0, 19)}</p>
      <p><strong>Verk√§ufer:</strong> ${username}</p>

      <table>
        <thead>
          <tr>
            <th>Produkt</th>
            <th>Barcode</th>
            <th>Menge</th>
            <th>St√ºckpreis (‚Ç¨)</th>
            <th>Gesamt (‚Ç¨)</th>
          </tr>
        </thead>
        <tbody>
          ${itemsHTML}
        </tbody>
      </table>

      <h4 style="text-align: right;">Gesamtsumme: <span style="color: green;">‚Ç¨${order.total_order_price.toFixed(2)}</span></h4>

      <p class="footer">Vielen Dank f√ºr Ihren Einkauf!</p>
    </body>
    </html>
  `;

  const receiptWindow = window.open('', '_blank', 'width=800,height=600');
  if (receiptWindow) {
    receiptWindow.document.open();
    receiptWindow.document.write(receiptHTML);
    receiptWindow.document.close();
  } else {
    alert("Pop-up Fenster blockiert. Bitte erlaube Pop-ups.");
  }
}





</script>
{% endblock %}
